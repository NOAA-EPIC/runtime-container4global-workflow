Bootstrap: docker
From: ubuntu:24.04

%labels
    Author="Wei Huang"
    Intel-OneAPI-Version="2024.2.x"
    Intel-MPI-Version="2021.13"
    Description="Ubuntu 24.04 container with Intel oneAPI 2024.2.x + MPI 2021.13"

%environment
    # Load Intel OneAPI environment on container start
    source /opt/intel/oneapi/setvars.sh > /dev/null 2>&1
    export PATH=/opt/intel/oneapi/mpi/2021.13/bin:$PATH
    export LD_LIBRARY_PATH=/opt/intel/oneapi/mpi/2021.13/lib:$LD_LIBRARY_PATH
    export I_MPI_OFI_PROVIDER=tcp
    export FI_PROVIDER=tcp

%post
    export DEBIAN_FRONTEND=noninteractive

    # -------------------------------
    # Basic system utilities
    # -------------------------------
    apt-get update && apt-get install -y \
        wget curl ca-certificates gnupg lsb-release \
        build-essential cmake git python3 python3-dev python3-pip \
        libnuma1 libnuma-dev libfabric1 libfabric-dev \
        openssh-client && apt-get clean

    # -------------------------------
    # Add Intel OneAPI repository
    # -------------------------------
    mkdir -p /etc/apt/keyrings
    wget -O /etc/apt/keyrings/intel-oneapi.asc \
        https://apt.repos.intel.com/oneapi/intel-oneapi-repo-key.asc
    chmod 644 /etc/apt/keyrings/intel-oneapi.asc

    echo "deb [signed-by=/etc/apt/keyrings/intel-oneapi.asc] https://apt.repos.intel.com/oneapi all main" \
        > /etc/apt/sources.list.d/intel-oneapi.list

    apt-get update

    # -------------------------------
    # Install pinned versions of oneAPI components
    # -------------------------------
    apt-get install -y \
        intel-oneapi-compiler-dpcpp-cpp=2024.2.0-495 \
        intel-oneapi-compiler-fortran=2024.2.0-495 \
        intel-oneapi-mkl=2024.2.0-495 \
        intel-oneapi-mkl-devel=2024.2.0-495 \
        intel-oneapi-tbb=2021.12.0-495 \
        intel-oneapi-mpi=2021.13-656 \
        intel-oneapi-mpi-devel=2021.13-656 \
        intel-oneapi-dev-utilities=2024.2.0-495

    apt-get clean
    rm -rf /var/lib/apt/lists/*

    # Ensure environment persists
    echo "source /opt/intel/oneapi/setvars.sh > /dev/null 2>&1" >> /environment

%runscript
    # Load Intel environment automatically
    source /opt/intel/oneapi/setvars.sh > /dev/null 2>&1
    echo "Intel OneAPI 2024.2.x + MPI 2021.13 environment active"
    exec /bin/bash


################################################################################
# Stage 1: Builder
# - Uses a local image with the full development environment (compilers, git).
# - Clones and builds the global-workflow application.
################################################################################
Bootstrap: localimage
From: ./intel-hpc-2024.2-mpi-2021.13-ss192.sif
Stage: builder

%post
    # Fail on error and print commands for easier debugging
    set -e
    set -x

    # Create and move into the working directory
    mkdir -p /opt
    cd /opt

    # Create common mount points needed for HPC environments
    mkdir -p /contrib /lustre /scratch /scratch3 /scratch4 /mnt /Users

################################################################################
# Stage 2: Final
# - Starts from a minimal Intel oneAPI runtime image.
# - Copies only the necessary compiled application and dependencies from the
#   builder stage, creating a much smaller and cleaner final container.
################################################################################
Bootstrap: docker
From: intel/hpckit:2024.2.0-1-devel-ubuntu22.04
Stage: final

%files from builder
    # Copy the compiled application and its Spack-Stack dependencies
    #/opt/global-workflow-cloud /opt/global-workflow-cloud
    /usr/lmod /usr/lmod
    #/opt/spack-stack /opt/spack-stack
    /usr/local/aws-cli /usr/local/aws-cli
    /usr/bin/time /usr/bin/time
    /usr/bin/bc /usr/bin/bc
    /usr/bin/lua /usr/bin/lua
    /usr/bin/envsubst /usr/bin/envsubst
    /usr/bin/rsync /usr/bin/rsync
    /usr/lib/lua /usr/lib/lua
    /usr/share/lua /usr/share/lua
    /usr/lib/x86_64-linux-gnu /usr/lib/x86_64-linux-gnu
    /etc/localtime /etc/localtime
    /usr/include/zlib.h /usr/include/zlib.h
    #/root /root # Be cautious with this; copy only what's necessary.
    #/var /var

    # CRITICAL: Avoid copying the entire /usr directory.
    # Instead, identify the specific libraries your application needs from the
    # builder and copy them explicitly. This keeps the final image small.
    # Example (you will need to find the actual paths):
    # /usr/lib/x86_64-linux-gnu/libsome-dependency.so.1 /usr/lib/x86_64-linux-gnu/

%post
    # This section is for tasks to run inside the final container, like setup.
    set -e
    set -x

    # Ensure vim is installed and configure alternatives
    apt-get update && apt-get install -y vim
    ln -sf /usr/bin/vim.basic /etc/alternatives/vi
    ln -sf /usr/bin/vim.basic /etc/alternatives/vim
    apt-get clean
    rm -rf /var/lib/apt/lists/*

%environment
    # Set the runtime environment for the final container.
    # This is the proper place to source scripts and set variables.
    export SHELL=/bin/bash
   #source /usr/lmod/lmod/init/bash
   #module purge

%runscript
    # This is the default command executed when you run the container.
    echo "Welcome to the Global Workflow container."
    echo "Starting interactive bash shell..."
    exec /bin/bash "$@"


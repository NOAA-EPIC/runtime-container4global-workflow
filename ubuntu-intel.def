Bootstrap: docker
From: ubuntu:24.04

%labels
    Author yourname
    OS Ubuntu 24.04
    Intel-OneAPI 2024.2
    Intel-MPI 2021.13

%environment
    # Intel OneAPI environment vars (loaded on container start)
    source /opt/intel/oneapi/setvars.sh > /dev/null 2>&1
    export I_MPI_DEBUG=0
    export FI_PROVIDER=psm3,shm
    export PATH=/opt/intel/oneapi/mpi/2021.13.0/bin:$PATH
    export LD_LIBRARY_PATH=/opt/intel/oneapi/mpi/2021.13.0/lib:$LD_LIBRARY_PATH

%post
    export DEBIAN_FRONTEND=noninteractive

    apt-get update && apt-get install -y \
        build-essential \
        cmake \
        git \
        wget \
        curl \
        unzip \
        ca-certificates \
        python3 python3-pip python3-dev \
        libnuma1 libnuma-dev \
        libfabric1 libfabric-dev \
        && apt-get clean

    # ----------------------------------------------------
    # Install Intel OneAPI 2024.2.0 (Base + HPC Toolkits)
    # ----------------------------------------------------
    mkdir -p /tmp/oneapi

    # Intel public apt repository key
    wget -qO - https://apt.repos.intel.com/intel-gpg-keys/Intel_GPG_Public_Key.tgz | \
        tar --strip-components=1 -xzf - -C /tmp/oneapi
    apt-key add /tmp/oneapi/*pub

    # Add Intel repo
    echo "deb https://apt.repos.intel.com/oneapi all main" \
        > /etc/apt/sources.list.d/oneAPI.list

    apt-get update

    # Install OneAPI Base + HPC Toolkit (2024.2)
    apt-get install -y \
        intel-basekit \
        intel-hpckit

    # ----------------------------------------------------
    # Set persistent environment
    # ----------------------------------------------------
    echo "source /opt/intel/oneapi/setvars.sh" >> /environment

%runscript
    echo "Intel OneAPI container (Ubuntu 24.04) - entering shell"
    exec /bin/bash


Bootstrap: docker
From: ubuntu:24.04

%environment
    # Set the root path for Intel installations
    export INTEL_ROOT=/opt/intel
    # Set up Intel oneAPI 2024.2.0 environment
    . ${INTEL_ROOT}/oneapi/setvars.sh

    # Variables for Intel MPI (part of oneAPI)
    export MPI_ROOT=${INTEL_ROOT}/oneapi/mpi/2021.13.0
    export PATH=${MPI_ROOT}/bin:${PATH}
    export LD_LIBRARY_PATH=${MPI_ROOT}/lib/release:${LD_LIBRARY_PATH}

    # Set up basic variables
    export DEBIAN_FRONTEND=noninteractive

%post
    # 1. Update and install basic dependencies
    apt-get update
    apt-get install -y --no-install-recommends \
        wget \
        gpg \
        build-essential \
        ca-certificates \
        gcc \
        g++ \
        python3 \
        libnuma-dev \
        dirmngr \
        apt-utils

    # Temporary step to find package versions:
    # echo "--- Available MPI Versions ---"
    # apt-cache madison intel-oneapi-mpi

    # --- DEBUGGING: Find the correct package name ---
    echo "--- Searching for Intel oneAPI packages ---"
    apt-cache search intel-oneapi-mpi
    apt-cache search intel-oneapi-
    echo "------------------------------------------"

    # 2. Install Intel oneAPI Repository Key
    wget -O- https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB | gpg --dearmor | tee /usr/share/keyrings/oneapi-archive-keyring.gpg > /dev/null

    # 3. Add Intel oneAPI Repository (for 2024.2.0)
    echo "deb [signed-by=/usr/share/keyrings/oneapi-archive-keyring.gpg] https://apt.repos.intel.com/oneapi all main" | tee /etc/apt/sources.list.d/oneAPI.list

    # 4. Install Intel oneAPI Base Toolkit (includes Intel MPI)
    # The versioning below explicitly requests the 2024.2.0 version.
    apt-get update

    # Temporary step to find package versions:
    # echo "--- Available MPI Versions ---"
    # apt-cache madison intel-oneapi-mpi

    # --- DEBUGGING: Find the correct package name ---
    echo "--- Searching for Intel oneAPI packages ---"
    apt-cache search intel-oneapi-mpi
    apt-cache search intel-oneapi-
    echo "------------------------------------------"

    # Use the unversioned package names and specify the version using =
    # Note: Intel MPI 2021.13 is often part of the 2024.2.0 release.
    # We will use the common version-build string for 2024.2.0, which is typically 2024.2.0-64
    INTEL_VERSION="2024.2.0-64"

    apt-get install -y --no-install-recommends \
        intel-oneapi-compiler-dpcpp-cpp=${INTEL_VERSION} \
        intel-oneapi-compiler-fortran=${INTEL_VERSION} \
        intel-oneapi-mpi=${INTEL_VERSION}

    # 5. Clean up
    apt-get autoremove -y && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

%runscript
    exec "$@"

%labels
    Maintainer "Your Name"
    Version "1.0"
    Description "Ubuntu 24.04 with Intel oneAPI 2024.2.0 and Intel MPI 2021.13"
